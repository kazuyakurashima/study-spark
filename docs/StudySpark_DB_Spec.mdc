---
description: 
globs: 
alwaysApply: false
---
## ğŸ“˜ StudySparkï¼šDBè¨­è¨ˆ è¦ä»¶å®šç¾©æ›¸ï¼ˆä¿®æ­£ç‰ˆãƒ»2025å¹´4æœˆæ™‚ç‚¹ï¼‰

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€StudySparkã‚¢ãƒ—ãƒªã«ãŠã‘ã‚‹SupabaseãŠã‚ˆã³ChatGPTé€£æºã‚’å‰æã¨ã—ãŸã€å …ç‰¢ã§æ‹¡å¼µæ€§ã®ã‚ã‚‹DBæ§‹æˆã‚’å®šç¾©ã™ã‚‹ã‚‚ã®ã§ã™ã€‚éå»ã®è­°è«–ã¨å¤–éƒ¨ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆby Geminiï¼‰ã‚’ã‚‚ã¨ã«æœ€é©åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚

---

### âœ… å…±é€šãƒã‚¹ã‚¿ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«

#### ğŸ“ avatarsï¼ˆã‚¢ãƒã‚¿ãƒ¼é¸æŠè‚¢ï¼‰
| ã‚«ãƒ©ãƒ å       | å‹     | èª¬æ˜                             |
|----------------|--------|----------------------------------|
| id             | String | ã‚¢ãƒã‚¿ãƒ¼è­˜åˆ¥å­ï¼ˆä¾‹: avatar1ï¼‰    |
| label          | String | è¡¨ç¤ºç”¨ãƒ©ãƒ™ãƒ«                     |
| image_path     | String | ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã®ç›¸å¯¾ãƒ‘ã‚¹           |

#### ğŸ“ test_name_options / reason_optionsï¼ˆé¸æŠè‚¢ãƒã‚¹ã‚¿ãƒ¼ï¼‰
| ã‚«ãƒ©ãƒ å       | å‹     | èª¬æ˜                             |
|----------------|--------|----------------------------------|
| id             | UUID   | ä¸»ã‚­ãƒ¼                           |
| label          | String | è¡¨ç¤ºç”¨ãƒ†ã‚­ã‚¹ãƒˆ                   |
| category       | String | ä½¿ç”¨ç®‡æ‰€ï¼ˆä¾‹ï¼š"goal_reason"ï¼‰    |
| is_custom      | Boolean| è‡ªç”±è¨˜è¿°ã‚’è¨±å¯ã™ã‚‹ã‹ã©ã†ã‹       |

---

### ğŸ‘¤ usersï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± / èªè¨¼ãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç®¡ç†ï¼‰
| ã‚«ãƒ©ãƒ å               | å‹       | èª¬æ˜                                    |
|------------------------|----------|-----------------------------------------|
| id                     | UUID     | auth.users.id ã«å¯¾å¿œ                   |
| email                  | String   | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹                          |
| display_name           | String   | è¡¨ç¤ºåï¼ˆ4ã€œ15æ–‡å­—ï¼‰                     |
| avatar_key             | String   | é¸æŠã‚¢ãƒã‚¿ãƒ¼ã®è­˜åˆ¥å­                   |
| onboarding_completed   | Boolean  | ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å®Œäº†ãƒ•ãƒ©ã‚°             |
| created_at             | Timestamp| ç™»éŒ²æ—¥æ™‚                                |
| updated_at             | Timestamp| æœ€çµ‚æ›´æ–°æ—¥æ™‚                            |

---

### ğŸ¯ goalsï¼ˆç›®æ¨™ãƒ»è©¦é¨“ç¯„å›²ç®¡ç†ï¼‰
| ã‚«ãƒ©ãƒ å       | å‹     | èª¬æ˜                                      |
|----------------|--------|-------------------------------------------|
| id             | UUID   | ä¸»ã‚­ãƒ¼                                     |
| user_id        | UUID   | ç´ä»˜ããƒ¦ãƒ¼ã‚¶ãƒ¼                             |
| test_name      | String | ãƒ†ã‚¹ãƒˆåï¼ˆé¸æŠ or è‡ªç”±å…¥åŠ›ã€3ã€œ40æ–‡å­—ï¼‰   |
| test_start_date| Date   | ãƒ†ã‚¹ãƒˆé–‹å§‹æ—¥                               |
| test_end_date  | Date   | ãƒ†ã‚¹ãƒˆçµ‚äº†æ—¥                               |
| total_students | Int    | å­¦å¹´äººæ•°ï¼ˆæ­£ã®æ•´æ•°ï¼‰                       |
| target_rank    | Int    | ç›®æ¨™é †ä½ï¼ˆ1ã€œtotal_studentsã®é–“ï¼‰         |
| reason_type    | String | "option" or "custom"                      |
| reason_text    | Text   | ç›®æ¨™ç†ç”±ï¼ˆ10ã€œ3000æ–‡å­—ï¼‰                  |
| created_at     | Timestamp| ä½œæˆæ—¥æ™‚                                |
| updated_at     | Timestamp| æ›´æ–°æ—¥æ™‚                                |

---

### ğŸ“š æ•™ææ§‹é€ ï¼ˆãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼‰

#### textbooks / chapters / sections / questions
æ¨™æº–çš„ãªæ§‹æˆï¼šå•é¡Œé›† â†’ ç«  â†’ é …ç›® â†’ å•é¡Œ

---

### ğŸ”¥ learning_plansï¼ˆã‚¹ãƒ‘ãƒ¼ã‚¯ï¼šå­¦ç¿’è¨ˆç”»ãƒ¡ã‚¿ï¼‰
| ã‚«ãƒ©ãƒ å       | å‹     | èª¬æ˜                             |
|----------------|--------|----------------------------------|
| id             | UUID   | ä¸»ã‚­ãƒ¼                           |
| user_id        | UUID   | ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥å­                   |
| goal_id        | UUID   | é–¢é€£ã™ã‚‹goals.id                 |
| generated_by   | String | "auto" or "coach"                |
| max_days       | Int    | æœ€å¤§å­¦ç¿’æ—¥æ•°                     |
| base_days      | Int    | åŸºæœ¬å­¦ç¿’æ—¥æ•°                     |
| final_study_date| Date  | å­¦ç¿’æœ€çµ‚æ—¥                       |
| review_days    | Int    | å¾©ç¿’æœŸé–“ï¼ˆæ—¥æ•°ï¼‰                 |
| review_weekdays| String[] | å¾©ç¿’æ›œæ—¥ï¼ˆä¾‹: ["Sun"]ï¼‰         |

---

### ğŸ”¥ learning_tasksï¼ˆæ—¥å˜ä½ã®å­¦ç¿’ã‚¿ã‚¹ã‚¯ï¼‰
| ã‚«ãƒ©ãƒ å       | å‹     | èª¬æ˜                              |
|----------------|--------|-----------------------------------|
| id             | UUID   | ä¸»ã‚­ãƒ¼                            |
| plan_id        | UUID   | ç´ä»˜ãå­¦ç¿’è¨ˆç”»                    |
| date           | Date   | ã‚¿ã‚¹ã‚¯å®Ÿæ–½äºˆå®šæ—¥                  |
| question_id    | UUID   | ç´ä»˜ãå•é¡Œ                        |
| order_in_day   | Int    | è¡¨ç¤ºé †                            |
| is_review_day  | Boolean| å¾©ç¿’æ—¥ã«è©²å½“ã™ã‚‹ã‹                |

---

### ğŸ“— question_attempt_logsï¼ˆå•é¡Œã®å­¦ç¿’çŠ¶æ…‹è¨˜éŒ²ï¼‰
| ã‚«ãƒ©ãƒ å       | å‹     | èª¬æ˜                              |
|----------------|--------|-----------------------------------|
| id             | UUID   | ä¸»ã‚­ãƒ¼                            |
| user_id        | UUID   | å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼                      |
| question_id    | UUID   | å¯¾è±¡å•é¡Œ                          |
| date           | Date   | çŠ¶æ…‹ã‚’è¨˜éŒ²ã—ãŸæ—¥ä»˜                |
| status         | String | correct / partial / wrong / not_started |
| source         | String | "spark", "manual", "countdown"ãªã© |
| updated_at     | Timestamp | è¨˜éŒ²æ—¥æ™‚                         |

---

### ğŸ§¾ plan_revisionsï¼ˆå†è¨ˆç”»ãƒ­ã‚°ï¼‰
| ã‚«ãƒ©ãƒ å       | å‹     | èª¬æ˜                             |
|----------------|--------|----------------------------------|
| id             | UUID   | ä¸»ã‚­ãƒ¼                           |
| plan_id        | UUID   | å…ƒã®å­¦ç¿’è¨ˆç”»                     |
| revision_type  | String | "auto" or "coach"               |
| selected_statuses | String[] | çŠ¶æ…‹ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆä¾‹: ["wrong"]ï¼‰ |
| revised_at     | Timestamp | ä¿®æ­£æ—¥æ™‚                        |

---

### ğŸ’¬ ãƒˆãƒ¼ã‚¯æ©Ÿèƒ½ï¼ˆå†…çœè¨˜éŒ²ï¼‰

#### daily_reflections / weekly_reflections / value_prompts / reflection_badges
æ—¢å®šé€šã‚Šã€‚`goal.reason_text`ã®å‚ç…§ã‚„`learning_tasks`ã®é€²æ—çŠ¶æ³ã¨é€£æºã€‚

---

## ğŸ” çµ±ä¸€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å›³ï¼ˆç°¡ç•¥ï¼‰
```
users
â”œâ”€â”€ goals
â”‚   â”œâ”€â”€ goal_subjects
â”‚   â””â”€â”€ goal_topics
â”‚       â””â”€â”€ chapters â†’ sections â†’ questions
â”‚
â”œâ”€â”€ learning_plans
â”‚   â”œâ”€â”€ learning_tasks
â”‚   â”œâ”€â”€ question_attempt_logs  â† çµ±åˆ
â”‚   â””â”€â”€ plan_revisions
â”‚
â”œâ”€â”€ daily_reflections
â”œâ”€â”€ weekly_reflections
â”œâ”€â”€ value_prompts
â””â”€â”€ reflection_badges
```

---

## âœ… è£œè¶³ï¼šå†—é•·æ€§ã®è§£æ¶ˆã«ä¼´ã†èª¿æ•´
- `daily_schedules` ã¯ `learning_tasks` ã«çµ±åˆï¼ˆdateé …ç›®ã‚ã‚Šï¼‰
- `question_status_logs` ã¨ `learning_task_logs` ã‚’çµ±åˆ â†’ `question_attempt_logs`

---

## âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨åˆ¶ç´„æ–¹é‡
- Supabase RLSï¼šå…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã§é©ç”¨å‰æ
- CHECKåˆ¶ç´„ï¼ˆä¾‹ï¼‰:
  - `CHECK (target_rank > 0 AND target_rank <= total_students)`
  - `CHECK (char_length(test_name) BETWEEN 3 AND 40)`
  - `CHECK (char_length(reason_text) BETWEEN 10 AND 3000)`
- ã‚¢ãƒ—ãƒªå´ã§è¨˜éŒ²å›æ•°ä¸Šé™ï¼ˆ5ä»¶ï¼‰åˆ¶å¾¡ â†’ DBã§åˆ¶é™ã¯è¨­ã‘ãªã„

---

## ğŸ§  ä»Šå¾Œã®æ‹¡å¼µè¦–ç‚¹
- `goals`ã« `actual_rank` ã‚„ `score` ã‚’è¿½åŠ ã—ã¦å®Ÿç¸¾ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
- `avatar_key` ã«ã‚ˆã‚‹ã‚¢ãƒã‚¿ãƒ¼åˆ‡ã‚Šæ›¿ãˆUIã®æ‹¡å……ï¼ˆå­£ç¯€ãƒ»ç§°å·é€£å‹•ï¼‰
- `value_prompts` ã®å‡ºé¡Œå±¥æ­´ã‹ã‚‰ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºåŒ–
- `question_attempt_logs` ã‹ã‚‰å‚¾å‘åˆ†æâ†’ã‚³ãƒ¼ãƒãƒ³ã‚°è‡ªå‹•ææ¡ˆï¼ˆAIï¼‰

---

ä»¥ä¸ŠãŒã€å…¨æ©Ÿèƒ½ãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ãƒ»çµ±åˆè¨­è¨ˆã‚’ãµã¾ãˆãŸ **StudySpark æœ€çµ‚DBè¨­è¨ˆè¦ä»¶å®šç¾©æ›¸ï¼ˆä¿®æ­£ç‰ˆï¼‰** ã§ã™ã€‚

